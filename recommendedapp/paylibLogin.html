<script>
navigator.serviceWorker.addEventListener('message', function (e) {
    console.log('got message:', e.data);
	console.log(e.data.Seal);	
	postTry(e.data.Data, e.data.Seal);
  var form = document.getElementById("loginForm");
  /* Note: message sent from payment app is available in e.data */
  form.onsubmit = function() {
	 console.log("on submit function");
	 var url_string = window.location.href; //window.location.href
   	 var url = new URL(url_string);
    	 var total = url.searchParams.get("total");
	 var login = document.getElementById("login").value;
	 var mdp = document.getElementById("password").value;

    /* See https://w3c.github.io/payment-handler/#paymenthandlerresponse-dictionary */
if (login =="test" && mdp =="test"){
	  var paymentAppResponse = {          
	  methodName: 'https://liamThiveux.github.io',
          details: {
              user: login,
	      password: mdp,
	      amount: total,
	      methodName: "Paylib POC",
              compte: "Liam thiveux",
              cardNumber: "4200 1234 4567 7891",
              token: "1234567890",
         }
    };

    e.source.postMessage(paymentAppResponse);
    window.close();
}
	  else {
	  	alert("Wrong login or password");
	  }
  }
});	
</script>
<html lang="en">
 
 <head>
     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
     <title>Payment Handler for Paylib</title>
     <link rel="icon" href="/favicon.ico">

 </head>
 <style type="text/css">
body, html {
    height: 100%;
}
.bg { 
    /* The image used */
    background-image: url("loginPage.png");
    /* Full height */
    height: 100%; 
    /* Center and scale the image nicely */
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover;
}
.contents {
    position: absolute;
    top: 70%;
    left: 30%;
    transform: translate(-50%, -50%);
  }
  </style>
  
 <body>
  <div class="bg">
	  <iframe onload="getContent()" title="my_iframe" id="my_iframe" name="my_iframe" src="" width="250" height="250">
		  <p> Doesn't support </p>
	  </iframe>
    <p style='position:absolute; top:3px; left:62%;' id='price'><font color='white' size='6'></font></p>
    <button style="position: absolute; left:32%; top:62%; width:200px; height:40px;" id="valider" onclick="clickMe()">Valider </button>
   <form id="loginForm">
    <input type="text" id="login" placeholder="Login" style="position:absolute; left:27%; top:40%; width:150px; height:25px;">
    <input type="password" id="password" placeholder="Password" style="position:absolute; left:27%; top:47%; width:150px; height:25px; display:none;">
    <button  style="position: absolute; left:32%; top:62%; width:200px; height:40px; display:none;" type="submit" id="submit">Submit </button>
   </form>
  </div>
  <script type="text/javascript" src="../sips/w3CPayment.js"></script>
  <script>
	  function getContent() {
	  	console.log("get Content from Iframe");
		  //var frame = window.frames["my_iframe"].document;
}
	  
   function clickMe()
{
    console.log("dans la function");
    document.getElementById("password").style.display = "block";
    document.getElementById("valider").style.display = "none";
    document.getElementById("submit").style.display = "block";
	document.getElementById("my_iframe");
	console.log("Click me");
}	  
	  
   console.log(window.my_amount);
   window.onload = fillPrice;
   
    function fillPrice(){
    console.log("in fill price");
    var url_string = window.location.href; //window.location.href
    var url = new URL(url_string);
    var total = url.searchParams.get("total");
    console.log(total);
    document.getElementById("price").innerHTML ="Price : " + total;
    }

    function postTry(data, seal){
	/*var today = new Date();
	var year = today.getFullYear();
	var month = today.getMonth() + 1;
	if (month < 10) {
        	month = "0" + month
    	}
	var day = today.getDate();
    	if (day < 10) {
        day = "0" + day
    }
    var h = today.getHours();
    if (h < 10) {
        h = "0" + h
    }
    var m = today.getMinutes();
    if (m < 10) {
        m = "0" + m
    }
    var s = today.getSeconds();
    if (s < 10) {
        s = "0" + s
    }

	i= year + month + day + h + m + s;*/
	    //var data = "automaticResponseURL=https://sims.ibt-agile.qlf.sips.priv.atos.fr/webservices/PaymentConfirmationCNRT/targetPaymentConfirmationAutoCNRT.jsp|normalReturnURL=https://sims.ibt-agile.qlf.sips.priv.atos.fr/webservices/PaymentConfirmation/PaymentConfirmation.jsp|merchantId=233118849141631|amount=1000|currencyCode=978|transactionReference=1519139063723|keyVersion=1|transactionOrigin=SIMS|automaticErrorResponseInitPOST=https://sims.ibt-agile.qlf.sips.priv.atos.fr/SipsAutomaticErrorInitResponseHandler|manualErrorResponseInitPOST=https://sims.ibt-agile.qlf.sips.priv.atos.fr/SipsManualResponseHandler";
	    //var seal = "a316fd5008eda4c69c2c87f68b0c0aac1a0ef5c7b72a2d3e6e373a608899e4f7";
	var params = {Data: data,
		      Encode: "",
		      Seal: seal,
		      InterfaceVersion: "HP_2.20", 
		      SealAlgorithm: ""
		     }
	post("https://payment-webinit.ibt-agile.qlf.sips.priv.atos.fr/paymentInit", params)
		}
	  
function post(path, params) {
    method = "post"; 

    // The rest of this code assumes you are not using a library.
    // It can be made less wordy if you use one.
    var form = document.createElement("form");
    form.setAttribute("method", "post");
    form.setAttribute("action", path);
    form.setAttribute("target","my_iframe");
    form.setAttribute("id","pwi1");

    for(var key in params) {
        if(params.hasOwnProperty(key)) {
            var hiddenField = document.createElement("input");
            hiddenField.setAttribute("type", "hidden");
            hiddenField.setAttribute("name", key);
            hiddenField.setAttribute("value", params[key]);

            form.appendChild(hiddenField);
        }
    }

    document.body.appendChild(form);
    form.submit();
}
  </script>
  </body>
</html>
